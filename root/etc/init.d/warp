#!/bin/sh /etc/rc.common
# Copyright (C) 2024
# SPDX-License-Identifier: GPL-3.0-or-later

START=99
STOP=10
USE_PROCD=1

PROG=/usr/bin/warp-manager
SOCKS_PID_FILE=/var/run/warp-socks.pid

start_service() {
    config_load warp
    config_get ENABLED config enabled 0
    [ "$ENABLED" != "1" ] && return 0
    
    # 获取配置
    config_get PRIVATE_KEY config private_key ""
    config_get ADDRESS_V4 config address_v4 ""
    config_get ADDRESS_V6 config address_v6 ""
    config_get MTU config mtu 1280
    config_get ENDPOINT config endpoint "engage.cloudflareclient.com:2408"
    config_get DNS config dns "1.1.1.1"
    
    config_get SOCKS_ENABLED config socks_enabled "1"
    config_get SOCKS_PORT config socks_port "1080"
    
    # 确保没有残留接口
    ip link delete warp >/dev/null 2>&1
    
    # 1. 创建接口
    ip link add dev warp type wireguard
    wg set warp private-key <(echo "$PRIVATE_KEY")
    
    # 2. 配置Peer
    # 解析endpoint
    local end_host="${ENDPOINT%:*}"
    local end_port="${ENDPOINT##*:}"
    
    # 如果有前置代理配置，这里需要特殊处理路由，暂且按标准流程
    # 简单的Peer配置
    wg set warp peer "bmXOC+F1FxEMF9dyiK2H5/1SUtzH0JuVo51h2wPfgyo=" \
        endpoint "$end_host:$end_port" \
        persistent-keepalive 25 \
        allowed-ips "0.0.0.0/0,::/0"
        
    # 3. 配置地址和路由
    ip address add "$ADDRESS_V4/32" dev warp
    [ -n "$ADDRESS_V6" ] && ip address add "$ADDRESS_V6/128" dev warp
    
    ip link set mtu "$MTU" dev warp
    ip link set up dev warp
    
    # 4. 添加路由 (使用简单粗暴的 ip route)
    # 计算wan网关
    local wan_gw=$(ip route show default | grep -v warp | awk '{print $3}' | head -1)
    
    # 添加Cloudflare endpoint的静态路由，防止死循环
    if [ -n "$wan_gw" ]; then
        # 解析endpoint IP (简单解析)
        local end_ip=$(nslookup "$end_host" 2>/dev/null | grep Address | awk '{print $2}' | tail -1)
        [ -n "$end_ip" ] && ip route add "$end_ip/32" via "$wan_gw" 2>/dev/null
    fi
    
    # 添加默认路由 (如果启用了全局代理)
    config_get GLOBAL_PROXY config global_proxy 1
    if [ "$GLOBAL_PROXY" = "1" ]; then
        # 添加两条 /1 路由覆盖默认路由，比删除默认路由更安全
        ip route add 0.0.0.0/1 dev warp
        ip route add 128.0.0.0/1 dev warp
    fi
    
    # 5. 防火墙 (简单的伪装)
    # 这部分必须配合 firewall config，或者直接用 iptables
    iptables -t nat -A POSTROUTING -o warp -j MASQUERADE
    
    # 6. SOCKS5
    if [ "$SOCKS_ENABLED" = "1" ]; then
        if command -v microsocks >/dev/null 2>&1; then
            microsocks -i 0.0.0.0 -p "$SOCKS_PORT" -b "$ADDRESS_V4" &
            echo $! > "$SOCKS_PID_FILE"
        fi
    fi
    
    logger -t warp "Service started via raw commands"
}

stop_service() {
    # 1. 直接杀掉 WireGuard 接口 (最快的方法)
    ip link delete warp >/dev/null 2>&1
    
    # 2. 清理 SOCKS 进程
    if [ -f "$SOCKS_PID_FILE" ]; then
        kill $(cat "$SOCKS_PID_FILE") 2>/dev/null
        rm -f "$SOCKS_PID_FILE"
    fi
    killall microsocks >/dev/null 2>&1
    killall gost >/dev/null 2>&1
    
    # 3. 清理路由 (接口删除后路由通常会自动消失，但为了保险)
    ip route del 0.0.0.0/1 dev warp >/dev/null 2>&1
    ip route del 128.0.0.0/1 dev warp >/dev/null 2>&1
    
    # 4. 清理防火墙
    iptables -t nat -D POSTROUTING -o warp -j MASQUERADE >/dev/null 2>&1
    
    logger -t warp "Service stopped forcefully"
}

reload_service() {
    stop_service
    start_service
}
